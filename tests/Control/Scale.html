<html>
<head>
  <script src="../OLLoader.js"></script>
  <script type="text/javascript">
    OpenLayers.Lang.setCode('en');
    var map; 
    function test_Control_Scale_constructor (t) {
        t.plan( 2 );
    
        control = new OpenLayers.Control.Scale();
        t.ok( control instanceof OpenLayers.Control.Scale, "new OpenLayers.Control returns object" );
        t.eq( control.displayClass,  "olControlScale", "displayClass is correct" );
    }
    function test_Control_Scale_initwithelem (t) {
        t.plan( 1 );
    
        control = new OpenLayers.Control.Scale(OpenLayers.Util.getElement('scale'));
        t.ok(true, "If this happens, then we passed. (FF throws an error above otherwise)");
    }
    function test_Control_Scale_updateScale (t) {
        t.plan( 4 );
    
        control = new OpenLayers.Control.Scale('scale');
        t.ok( control instanceof OpenLayers.Control.Scale, "new OpenLayers.Control returns object" );
        map = new OpenLayers.Map('map');
        layer = new OpenLayers.Layer.WMS('Test Layer', "http://octo.metacarta.com/cgi-bin/mapserv", {map: '/mapdata/vmap_wms.map', layers: 'basic', format: 'image/jpeg'});
        map.addLayer(layer);
        map.zoomTo(0);
        map.addControl(control);
        t.eq(OpenLayers.Util.getElement('scale').innerHTML, "Scale = 1 : 443M", "Scale set by default."  );
        map.zoomIn();
        t.eq(OpenLayers.Util.getElement('scale').innerHTML, "Scale = 1 : 221M", "Zooming in changes scale"  );
        map.baseLayer.resolutions = [OpenLayers.Util.getResolutionFromScale(110)];
        map.zoomTo(0);
        t.eq(OpenLayers.Util.getElement('scale').innerHTML, "Scale = 1 : 110", "Scale of 100 isn't rounded"  );
    }
    function test_Control_Scale_internalScale (t) {
        t.plan(2);
        control = new OpenLayers.Control.Scale();
        t.ok( control instanceof OpenLayers.Control.Scale, "new OpenLayers.Control returns object" );
        map = new OpenLayers.Map('map');
        layer = new OpenLayers.Layer.WMS('Test Layer', "http://octo.metacarta.com/cgi-bin/mapserv", {map: '/mapdata/vmap_wms.map', layers: 'basic', format: 'image/jpeg'});
        map.addLayer(layer);
        map.zoomTo(0);
        map.addControl(control);
        t.eq(control.div.firstChild.innerHTML, "Scale = 1 : 443M", "Internal scale displayed properly.");
    }    
    
    function test_Scale_AddControl(t) {
        t.plan(3);

        var map = new OpenLayers.Map('map', {controls: []});

        function inViewPortDiv(div) {
            for(var i=0; i < map.viewPortDiv.childNodes.length; i++) {
                var childNode = map.viewPortDiv.childNodes[i];
                if (childNode == control.div) {
                    return true;
                }
            }
            return false;
        }

        var control, childNodesLength;

        childNodesLength = map.viewPortDiv.childNodes.length;

        // add a Scale to the map
        control = new OpenLayers.Control.Scale();
        map.addControlToMap(control);
        t.eq(map.viewPortDiv.childNodes.length, childNodesLength + 1,
             'one child node added to viewport div');
        t.ok(inViewPortDiv(control.div), 'Scale div is in viewport div');
        control.destroy();

        childNodesLength = map.viewPortDiv.childNodes.length;

        // add to the map a Scale using a HTML element outside viewport 
        control = new OpenLayers.Control.Scale('scale');
        map.addControlToMap(control);
        t.eq(map.viewPortDiv.childNodes.length, childNodesLength,
             'no child node added to viewport div');
        control.destroy();
        
        map.destroy();
    }
  </script>
</head>
<body>
    <a id="scale" href="">Scale</a> <br />
    <div id="map" style="width: 1024px; height: 512px;"/>
</body>
</html>
